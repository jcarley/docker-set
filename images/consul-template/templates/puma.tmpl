{{with $application_env := env "APPLICATION_ENV" | toLower}}{{with $d := tree "service/environments" | byKey}}{{if $d}}
{{$app := index $d $application_env}}{{if $app.puma}}{{$settings := $app.puma.Value | parseJSON}}

pidfile "/tmp/pids/puma.pid"
state_path "/tmp/pids/puma.state"
bind 'tcp://0.0.0.0:{{$settings.bind_port}}'
environment '{{$application_env}}'

threads 5, 16

# Use the following curl request to get stats about puma
# curl 127.0.0.1:6464?token=foo
activate_control_app 'tcp://0.0.0.0:{{$settings.control_app_port}}', { auth_token: 'foo' }

on_restart do
 ActiveRecord::Base.connection_pool.disconnect!
end
{{else}}
pidfile "/tmp/pids/puma.pid"
state_path "/tmp/pids/puma.state"
bind 'tcp://0.0.0.0:3000'
environment 'development'

threads 5, 16

# Use the following curl request to get stats about puma
# curl 127.0.0.1:6464?token=foo
activate_control_app 'tcp://0.0.0.0:2727', { auth_token: 'foo' }

on_restart do
 ActiveRecord::Base.connection_pool.disconnect!
end
{{end}}{{end}}{{end}}{{end}}
